<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Titre de la page</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>
  <body>
    <div id="tester" style="width: 90%; height: 250px"></div>
    <button id="reset_button">Reset</button>
    <button id="stop_button">Stop</button>
  </body>
  <script>
    N_ELEMENT_MEAN = 5;
    last_elements = [];
    function push_last_elements(element) {
      last_elements.push(element);
      if (last_elements.length > N_ELEMENT_MEAN) {
        last_elements.shift();
      }
    }
    function compute_mean_last_elements() {
      if (last_elements.length == 0) return 0;
      return last_elements.reduce((a, b) => a + b, 0) / last_elements.length;
    }

    x_values = [];
    y_values = [];
    y_values_mean = [];
    do_acquisition = true;
    TESTER = document.getElementById("tester");

    function plot(first = false) {
      if (!first) {
        Plotly.deleteTraces(TESTER, 1);
        Plotly.deleteTraces(TESTER, 0);
      }
      console.log(x_values);
      console.log(y_values);
      console.log(y_values_mean);
      Plotly.plot(
        TESTER,
        [
          {
            x: x_values,
            y: y_values,
          },
          {
            x: x_values,
            y: y_values_mean,
          },
        ],
        {
          margin: { t: 0 },
        },
        { showSendToCloud: true }
      );
    }
    plot((first = true));

    reset_button = document.getElementById("reset_button");
    reset_button.addEventListener("click", function () {
      x_values.length = 0;
      y_values.length = 0;
      y_values_mean.length = 0;
      plot();
    });

    stop_button = document.getElementById("stop_button");
    stop_button.addEventListener("click", function () {
      do_acquisition = !do_acquisition;
      if (do_acquisition) {
        stop_button.innerHTML = "Stop";
      } else {
        stop_button.innerHTML = "Resume";
      }
    });

    /* Current Plotly.js version */
    console.log(Plotly.BUILD);

    var gateway = `ws://${window.location.hostname}/ws`;
    var websocket;
    window.addEventListener("load", onLoad);
    function initWebSocket() {
      console.log("Trying to open a WebSocket connection...");
      websocket = new WebSocket(gateway);
      websocket.onopen = onOpen;
      websocket.onclose = onClose;
      websocket.onmessage = onMessage;
    }
    function onOpen(event) {
      console.log("Connection opened");
    }
    function onClose(event) {
      console.log("Connection closed");
      setTimeout(initWebSocket, 2000);
    }
    function onMessage(event) {
      if (do_acquisition) {
        data = parseFloat(event.data);
        y_values.push(data);
        x_values.push(x_values.length + 1);
        push_last_elements(data);
        y_values_mean.push(compute_mean_last_elements());
        plot();
      }
    }
    function onLoad(event) {
      initWebSocket();
    }
    function toggle() {
      websocket.send("toggle");
    }
  </script>
</html>
